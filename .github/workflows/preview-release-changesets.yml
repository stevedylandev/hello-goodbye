name: Preview Release (Changesets)

on:
  workflow_dispatch:
    inputs:
      custom_suffix:
        description: 'Custom suffix (overrides branch name)'
        type: string
        required: false
      publish_target:
        description: 'Choose to publish just to NPM or NPM + ghcr'
        type: choice
        required: true
        default: 'npm-and-ghcr'
        options:
          - npm-only
          - npm-and-ghcr

concurrency:
  group: prerelease-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  validate-and-prepare:
    name: Validate Branch & Prepare
    runs-on: ubuntu-latest
    if: github.repository == 'stevedylandev/hello-goodbye'
    outputs:
      branch-suffix: ${{ steps.prepare.outputs.branch-suffix }}
      dist-tag: ${{ steps.prepare.outputs.dist-tag }}
      snapshot-tag: ${{ steps.prepare.outputs.snapshot-tag }}
      docker-tag-base: ${{ steps.prepare.outputs.docker-tag-base }}
      commit-sha: ${{ steps.prepare.outputs.commit-sha }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Validate branch
        run: |
          if [[ "${{ github.ref_name }}" == "main" ]]; then
            echo "‚ùå Cannot run prerelease workflow on main branch"
            echo "Use the snapshot workflow instead for main branch previews"
            exit 1
          fi
          echo "‚úÖ Branch validation passed: ${{ github.ref_name }}"

      - name: Prepare tags and identifiers
        id: prepare
        run: |
          # Get short commit SHA
          COMMIT_SHA=$(git rev-parse --short HEAD)

          # Sanitize branch name for use in versions and tags
          if [[ -n "${{ inputs.custom_suffix }}" ]]; then
            BRANCH_SUFFIX="${{ inputs.custom_suffix }}"
          else
            BRANCH_SUFFIX="${{ github.ref_name }}"
            # Replace / with -
            BRANCH_SUFFIX="${BRANCH_SUFFIX//\//-}"
            # Replace special characters with -
            BRANCH_SUFFIX="${BRANCH_SUFFIX//[^a-zA-Z0-9-]/-}"
            # Convert to lowercase
            BRANCH_SUFFIX=$(echo "$BRANCH_SUFFIX" | tr '[:upper:]' '[:lower:]')
            # Remove consecutive dashes (repeat until no more changes)
            while [[ "$BRANCH_SUFFIX" =~ --+ ]]; do
              BRANCH_SUFFIX="${BRANCH_SUFFIX//--/-}"
            done
            # Truncate to 30 characters
            BRANCH_SUFFIX="${BRANCH_SUFFIX:0:30}"
            # Remove trailing dashes
            BRANCH_SUFFIX="${BRANCH_SUFFIX%-}"
            # Remove leading dashes
            BRANCH_SUFFIX="${BRANCH_SUFFIX#-}"
          fi

          # Create dist-tag (NPM doesn't allow dots in tags)
          DIST_TAG="preview-${BRANCH_SUFFIX}"

          # Snapshot tag for changesets (used in version string)
          SNAPSHOT_TAG="preview-${BRANCH_SUFFIX}"

          # Docker tag base (no version, just branch)
          DOCKER_TAG_BASE="preview-${BRANCH_SUFFIX}"

          echo "branch-suffix=${BRANCH_SUFFIX}" >> $GITHUB_OUTPUT
          echo "dist-tag=${DIST_TAG}" >> $GITHUB_OUTPUT
          echo "snapshot-tag=${SNAPSHOT_TAG}" >> $GITHUB_OUTPUT
          echo "docker-tag-base=${DOCKER_TAG_BASE}" >> $GITHUB_OUTPUT
          echo "commit-sha=${COMMIT_SHA}" >> $GITHUB_OUTPUT

          echo "üè∑Ô∏è  NPM dist-tag: ${DIST_TAG}"
          echo "üì∏ Snapshot tag: ${SNAPSHOT_TAG}"
          echo "üê≥ Docker tag base: ${DOCKER_TAG_BASE}"
          echo "üìù Commit SHA: ${COMMIT_SHA}"

  build-and-publish-npm:
    name: Build & Publish NPM
    runs-on: ubuntu-latest
    needs: validate-and-prepare
    permissions:
      contents: read
      id-token: write
    outputs:
      published-version: ${{ steps.publish.outputs.published-version }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build packages
        run: pnpm packages:prepublish

      - name: Version packages with changesets (snapshot)
        run: |
          # Use changesets to create snapshot versions
          # The snapshot tag will be used as part of the version string
          pnpm changeset version --snapshot ${{ needs.validate-and-prepare.outputs.snapshot-tag }}

          echo "üì¶ Packages versioned with snapshot tag: ${{ needs.validate-and-prepare.outputs.snapshot-tag }}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish packages with changesets
        id: publish
        run: |
          # Publish with changesets using snapshot mode
          # --no-git-tag: Don't create git tags for preview releases
          # --snapshot: Publish as snapshot/preview release
          # --tag: Use our custom dist-tag
          pnpm changeset publish --no-git-tag --snapshot --tag ${{ needs.validate-and-prepare.outputs.dist-tag }}

          # Extract published version from package.json
          PUBLISHED_VERSION=$(node -p "require('./apps/hello/package.json').version")
          echo "published-version=${PUBLISHED_VERSION}" >> $GITHUB_OUTPUT

          echo "‚úÖ Published packages:"
          echo "  - @stevedylandev/hello@${PUBLISHED_VERSION}"
          echo "  - @stevedylandev/goodbye@${PUBLISHED_VERSION}"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

  build-docker-images:
    name: Build Docker Images
    runs-on: ubuntu-latest
    needs: [validate-and-prepare, build-and-publish-npm]
    if: inputs.publish_target == 'npm-and-ghcr'
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        app: [hello, goodbye]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Build & Push Docker Image
        uses: ./.github/actions/build_docker_image
        with:
          image: ghcr.io/${{ github.repository_owner }}/${{ matrix.app }}
          dockerfile: apps/${{ matrix.app }}/Dockerfile
          registry_user: ${{ github.actor }}
          registry_token: ${{ secrets.GITHUB_TOKEN }}
          tags: |
            type=raw,value=${{ needs.validate-and-prepare.outputs.docker-tag-base }}
            type=raw,value=${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}

  detect-pr-and-comment:
    name: Update PR Comment
    runs-on: ubuntu-latest
    needs: [validate-and-prepare, build-and-publish-npm, build-docker-images]
    if: always() && (needs.build-and-publish-npm.result == 'success' || needs.build-docker-images.result == 'success')
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Detect PR
        id: detect-pr
        run: |
          # Try to find PR for this branch
          PR_DATA=$(gh pr list --state=open --head="${{ github.ref_name }}" --base=main --json number,title,url --limit 1)

          if [[ "$PR_DATA" != "[]" && -n "$PR_DATA" ]]; then
            PR_NUMBER=$(echo "$PR_DATA" | jq -r '.[0].number')
            PR_TITLE=$(echo "$PR_DATA" | jq -r '.[0].title')
            PR_URL=$(echo "$PR_DATA" | jq -r '.[0].url')

            echo "pr-number=${PR_NUMBER}" >> $GITHUB_OUTPUT
            echo "pr-title=${PR_TITLE}" >> $GITHUB_OUTPUT
            echo "pr-url=${PR_URL}" >> $GITHUB_OUTPUT
            echo "has-pr=true" >> $GITHUB_OUTPUT

            echo "‚úÖ Found PR #${PR_NUMBER}: ${PR_TITLE}"
          else
            echo "has-pr=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è  No open PR found for branch ${{ github.ref_name }}"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate comment body
        id: comment
        if: steps.detect-pr.outputs.has-pr == 'true'
        run: |
          # Build timestamp for display
          BUILD_TIME=$(date -u +"%Y-%m-%d %H:%M:%S UTC")

          # Start building comment
          COMMENT_BODY="## üöÄ Preview Packages - \`${{ github.ref_name }}\`

          "

          # NPM section
          if [[ "${{ needs.build-and-publish-npm.result }}" == "success" ]]; then
            COMMENT_BODY+="**NPM Packages:**
          \`\`\`bash
          # Install latest preview for this branch
          npm install @stevedylandev/hello@${{ needs.validate-and-prepare.outputs.dist-tag }}
          npm install @stevedylandev/goodbye@${{ needs.validate-and-prepare.outputs.dist-tag }}

          # Or install specific version
          npm install @stevedylandev/hello@${{ needs.build-and-publish-npm.outputs.published-version }}
          npm install @stevedylandev/goodbye@${{ needs.build-and-publish-npm.outputs.published-version }}
          \`\`\`

          "
          fi

          # Docker section - only show if Docker images were built
          if [[ "${{ inputs.publish_target }}" == "npm-and-ghcr" && "${{ needs.build-docker-images.result }}" == "success" ]]; then
            COMMENT_BODY+="**Docker Images:**
          \`\`\`bash
          docker pull ghcr.io/${{ github.repository_owner }}/hello:${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}
          docker pull ghcr.io/${{ github.repository_owner }}/goodbye:${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}
          \`\`\`

          "
          fi

          # Build info
          COMMENT_BODY+="**Build Info:**
          - üì¶ Version: \`${{ needs.build-and-publish-npm.outputs.published-version }}\`
          - üìù Commit: \`${{ needs.validate-and-prepare.outputs.commit-sha }}\`
          - üåø Branch: \`${{ github.ref_name }}\`
          - üéØ Target: \`${{ inputs.publish_target }}\`
          - ‚è∞ Built: \`${BUILD_TIME}\`
          - üîó [Workflow Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

          ---
          *ü§ñ This comment will be updated on subsequent preview builds*

          > **Note:** Preview packages are managed by changesets. NPM dist-tags can be cleaned up manually using \`npm dist-tag rm @stevedylandev/hello ${{ needs.validate-and-prepare.outputs.dist-tag }}\`"

          # Save to file for proper multiline handling
          echo "$COMMENT_BODY" > comment_body.txt
          echo "comment-file=comment_body.txt" >> $GITHUB_OUTPUT

      - name: Find existing comment
        id: find-comment
        if: steps.detect-pr.outputs.has-pr == 'true'
        run: |
          # Look for existing comment from github-actions bot
          COMMENT_ID=$(gh pr view ${{ steps.detect-pr.outputs.pr-number }} --json comments --jq '.comments[] | select(.author.login == "github-actions" and (.body | contains("üöÄ Preview Packages"))) | .id' | head -1)

          if [[ -n "$COMMENT_ID" ]]; then
            echo "existing-comment-id=${COMMENT_ID}" >> $GITHUB_OUTPUT
            echo "‚úÖ Found existing comment ID: ${COMMENT_ID}"
          else
            echo "‚ÑπÔ∏è  No existing comment found, will create new one"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update or create PR comment
        if: steps.detect-pr.outputs.has-pr == 'true'
        run: |
          if [[ -n "${{ steps.find-comment.outputs.existing-comment-id }}" ]]; then
            # Update existing comment
            gh pr comment ${{ steps.detect-pr.outputs.pr-number }} --edit-last --body-file ${{ steps.comment.outputs.comment-file }}
            echo "‚úÖ Updated existing PR comment"
          else
            # Create new comment
            gh pr comment ${{ steps.detect-pr.outputs.pr-number }} --body-file ${{ steps.comment.outputs.comment-file }}
            echo "‚úÖ Created new PR comment"
          fi
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log summary
        run: |
          echo "## üìã Preview Release Summary"
          echo "- Branch: ${{ github.ref_name }}"
          echo "- Publish target: ${{ inputs.publish_target }}"
          echo "- Published version: ${{ needs.build-and-publish-npm.outputs.published-version }}"
          echo "- NPM dist-tag: ${{ needs.validate-and-prepare.outputs.dist-tag }}"
          if [[ "${{ inputs.publish_target }}" == "npm-and-ghcr" ]]; then
            echo "- Docker tag: ${{ needs.validate-and-prepare.outputs.docker-tag-base }}-${{ needs.validate-and-prepare.outputs.commit-sha }}"
            echo "- Docker build: ${{ needs.build-docker-images.result }}"
          fi
          echo "- NPM publish: ${{ needs.build-and-publish-npm.result }}"
          echo "- PR detected: ${{ steps.detect-pr.outputs.has-pr }}"
          if [[ "${{ steps.detect-pr.outputs.has-pr }}" == "true" ]]; then
            echo "- PR number: #${{ steps.detect-pr.outputs.pr-number }}"
          fi
